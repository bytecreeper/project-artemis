{% extends "base.html" %}
{% set active = "hunt" %}
{% block title %}Artemis — Hunt{% endblock %}

{% block head %}
<style>
    .hunt-layout {
        display: grid;
        grid-template-columns: 1fr 360px;
        gap: 16px;
        height: calc(100vh - 120px);
    }
    .hunt-main { display: flex; flex-direction: column; gap: 16px; overflow: hidden; }
    .hunt-sidebar { display: flex; flex-direction: column; gap: 16px; overflow: hidden; }

    /* Search bar */
    .search-bar {
        display: flex; gap: 8px; align-items: center;
        padding: 12px 16px;
        background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px;
    }
    .search-bar input[type="text"] {
        flex: 1; background: var(--bg-base); border: 1px solid var(--border);
        color: var(--text-primary); padding: 8px 12px; border-radius: 4px;
        font-family: var(--font-mono); font-size: 13px;
    }
    .search-bar input:focus { outline: none; border-color: var(--amber); }
    .search-bar select {
        background: var(--bg-base); border: 1px solid var(--border);
        color: var(--text-secondary); padding: 8px; border-radius: 4px; font-size: 12px;
    }

    /* Results */
    .result-item {
        padding: 10px 14px; border-bottom: 1px solid var(--border);
        cursor: pointer; transition: background 0.15s; font-size: 12px;
    }
    .result-item:hover { background: var(--bg-card-hover); }
    .result-item.selected { background: rgba(245,166,35,0.08); border-left: 3px solid var(--amber); }
    .result-header { display: flex; gap: 8px; align-items: center; margin-bottom: 4px; }
    .result-header .time { color: var(--text-muted); font-family: var(--font-mono); font-size: 11px; }
    .result-header .type-tag {
        font-family: var(--font-mono); font-size: 10px; padding: 1px 6px;
        border-radius: 3px; background: rgba(245,166,35,0.1); color: var(--amber-dim);
    }
    .result-header .sev-badge {
        font-size: 10px; padding: 1px 5px; border-radius: 3px; font-weight: 700;
    }
    .sev-0 { background: rgba(85,85,85,0.2); color: #888; }
    .sev-1 { background: rgba(46,204,113,0.15); color: var(--green); }
    .sev-2 { background: rgba(241,196,15,0.15); color: #f1c40f; }
    .sev-3 { background: rgba(245,166,35,0.15); color: var(--amber); }
    .sev-4 { background: rgba(231,76,60,0.15); color: var(--red); }
    .result-detail { color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* Detail panel */
    .detail-panel { overflow-y: auto; }
    .detail-panel pre {
        font-size: 11px; line-height: 1.5; white-space: pre-wrap; word-break: break-all;
        background: var(--bg-base); padding: 12px; border-radius: 6px; border: 1px solid var(--border);
        color: var(--text-secondary); max-height: 300px; overflow-y: auto;
    }
    .detail-field { margin-bottom: 10px; }
    .detail-field .label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 2px; }
    .detail-field .value { font-family: var(--font-mono); font-size: 12px; color: var(--text-primary); }

    /* AI panel */
    .ai-panel textarea {
        width: 100%; background: var(--bg-base); border: 1px solid var(--border);
        color: var(--text-primary); padding: 8px; border-radius: 4px;
        font-size: 12px; resize: vertical; min-height: 60px;
    }
    .ai-panel textarea:focus { outline: none; border-color: var(--amber); }
    .ai-response {
        font-size: 12px; line-height: 1.6; color: var(--text-secondary);
        background: var(--bg-base); padding: 12px; border-radius: 6px;
        border: 1px solid var(--border); max-height: 300px; overflow-y: auto;
        white-space: pre-wrap;
    }

    /* Stats */
    .hunt-stats { display: flex; gap: 16px; font-size: 11px; color: var(--text-muted); }
    .hunt-stats span { font-family: var(--font-mono); }
    .hunt-stats .num { color: var(--amber); font-weight: 700; }
</style>
{% endblock %}

{% block content %}
<div x-data="hunt()" x-init="init()">
    <!-- Search bar -->
    <div class="search-bar" style="margin-bottom: 16px;">
        <span style="color: var(--amber); font-weight: 700;">[~]</span>
        <input type="text" x-model="query" @keydown.enter="search()"
               placeholder="Search events... (process name, IP, path, command line)">
        <select x-model="filters.eventType">
            <option value="">All Types</option>
            <option value="edr.process">Processes</option>
            <option value="edr.file">File Changes</option>
            <option value="net.">Network</option>
            <option value="correlation">Alerts</option>
        </select>
        <select x-model="filters.minSeverity">
            <option value="0">Any Severity</option>
            <option value="1">Low+</option>
            <option value="2">Medium+</option>
            <option value="3">High+</option>
            <option value="4">Critical</option>
        </select>
        <select x-model="filters.hours">
            <option value="">All Time</option>
            <option value="1">Last Hour</option>
            <option value="6">Last 6h</option>
            <option value="24">Last 24h</option>
            <option value="168">Last 7d</option>
        </select>
        <button class="btn btn-primary" @click="search()">Hunt</button>
    </div>

    <div class="hunt-layout">
        <!-- Main: Results -->
        <div class="hunt-main">
            <div class="card" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <h3>[~] Results</h3>
                    <div class="hunt-stats">
                        <span><span class="num" x-text="results.length"></span> results</span>
                        <span x-show="searchTime > 0"><span class="num" x-text="searchTime + 'ms'"></span></span>
                    </div>
                </div>
                <div style="flex: 1; overflow-y: auto;">
                    <template x-if="results.length === 0 && !loading">
                        <div style="padding: 40px; text-align: center; color: var(--text-muted);">
                            <div style="font-family: var(--font-mono); font-size: 18px; color: var(--amber-dim); margin-bottom: 8px;">[~]</div>
                            <div>Enter a search query to begin threat hunting</div>
                            <div style="font-size: 11px; margin-top: 8px;">
                                Try: powershell, cmd.exe, 192.168, svchost, mimikatz
                            </div>
                        </div>
                    </template>
                    <template x-if="loading">
                        <div style="padding: 40px; text-align: center; color: var(--amber);">Searching...</div>
                    </template>
                    <template x-for="(event, idx) in results" :key="event.id">
                        <div class="result-item" :class="selectedIdx === idx ? 'selected' : ''"
                             @click="selectEvent(idx)">
                            <div class="result-header">
                                <span class="time" x-text="formatTime(event.timestamp)"></span>
                                <span class="type-tag" x-text="shortType(event.type)"></span>
                                <span class="sev-badge" :class="'sev-' + event.severity"
                                      x-text="sevLabel(event.severity)"></span>
                                <span style="color: var(--text-muted); font-size: 10px;" x-text="event.source"></span>
                            </div>
                            <div class="result-detail" x-text="eventSummary(event)"></div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Sidebar: Detail + AI -->
        <div class="hunt-sidebar">
            <!-- Event Detail -->
            <div class="card detail-panel" style="flex: 1; overflow-y: auto;">
                <h3 style="margin-bottom: 10px;">[i] Detail</h3>
                <template x-if="!selected">
                    <div style="padding: 20px; text-align: center; color: var(--text-muted); font-size: 12px;">
                        Select an event to inspect
                    </div>
                </template>
                <template x-if="selected">
                    <div>
                        <div class="detail-field">
                            <div class="label">Event Type</div>
                            <div class="value" x-text="selected.type"></div>
                        </div>
                        <div class="detail-field">
                            <div class="label">Timestamp</div>
                            <div class="value" x-text="selected.timestamp"></div>
                        </div>
                        <div class="detail-field">
                            <div class="label">Source</div>
                            <div class="value" x-text="selected.source"></div>
                        </div>
                        <div class="detail-field">
                            <div class="label">Severity</div>
                            <div class="value">
                                <span class="sev-badge" :class="'sev-' + selected.severity"
                                      x-text="sevLabel(selected.severity)"></span>
                            </div>
                        </div>
                        <div class="detail-field">
                            <div class="label">Data</div>
                            <pre x-text="JSON.stringify(selected.data, null, 2)"></pre>
                        </div>
                        <button class="btn" style="width: 100%; margin-top: 8px;"
                                @click="analyzeSelected()">
                            [AI] Analyze Event
                        </button>
                    </div>
                </template>
            </div>

            <!-- AI Analysis -->
            <div class="card ai-panel" style="max-height: 40%;">
                <h3 style="margin-bottom: 10px;">[AI] Threat Analysis</h3>
                <textarea x-model="aiQuestion" placeholder="Ask about this event..."></textarea>
                <button class="btn btn-primary" style="width: 100%; margin-top: 6px;"
                        :disabled="aiLoading" @click="askAI()">
                    <span x-show="!aiLoading">Analyze</span>
                    <span x-show="aiLoading">Thinking...</span>
                </button>
                <template x-if="aiResponse">
                    <div class="ai-response" style="margin-top: 8px;" x-text="aiResponse"></div>
                </template>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function hunt() {
    return {
        query: '',
        filters: { eventType: '', minSeverity: 0, hours: '' },
        results: [],
        loading: false,
        searchTime: 0,
        selectedIdx: -1,
        selected: null,
        aiQuestion: 'Analyze this security event for potential threats, MITRE ATT&CK mapping, and recommended actions.',
        aiResponse: '',
        aiLoading: false,

        async init() {
            // Load last 50 events by default
            await this.search();
        },

        async search() {
            this.loading = true;
            this.selectedIdx = -1;
            this.selected = null;
            const start = performance.now();

            const params = new URLSearchParams();
            if (this.query) params.set('q', this.query);
            if (this.filters.eventType) params.set('event_type', this.filters.eventType);
            if (this.filters.minSeverity > 0) params.set('min_severity', this.filters.minSeverity);
            if (this.filters.hours) params.set('hours', this.filters.hours);
            params.set('limit', '200');

            try {
                const resp = await fetch('/api/search?' + params);
                this.results = await resp.json();
            } catch (e) {
                console.error('Search failed:', e);
                this.results = [];
            }

            this.searchTime = Math.round(performance.now() - start);
            this.loading = false;
        },

        selectEvent(idx) {
            this.selectedIdx = idx;
            this.selected = this.results[idx];
        },

        async analyzeSelected() {
            if (!this.selected) return;
            this.aiQuestion = 'Analyze this security event for potential threats, MITRE ATT&CK mapping, and recommended actions.';
            await this.askAI();
        },

        async askAI() {
            if (!this.selected && !this.query) return;
            this.aiLoading = true;
            this.aiResponse = '';

            const context = this.selected
                ? JSON.stringify(this.selected, null, 2)
                : `Search query: ${this.query}\nResults: ${this.results.length} events`;

            try {
                const resp = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ context, question: this.aiQuestion }),
                });
                const data = await resp.json();
                this.aiResponse = data.analysis || data.detail || 'No response';
            } catch (e) {
                this.aiResponse = 'AI analysis unavailable: ' + e.message;
            }

            this.aiLoading = false;
        },

        // Formatters
        formatTime(ts) {
            if (!ts) return '';
            const d = new Date(ts);
            return d.toLocaleString('en-US', { hour12: false, month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' });
        },

        shortType(type) {
            if (!type) return '';
            const parts = type.split('.');
            return parts.slice(-2).join('.');
        },

        sevLabel(sev) {
            return ['info', 'low', 'medium', 'high', 'critical'][sev] || 'unknown';
        },

        eventSummary(event) {
            const d = event.data;
            if (!d) return '';
            if (d.name && d.cmdline) return `${d.name} → ${d.cmdline.substring(0, 120)}`;
            if (d.name && d.exe) return `${d.name} (${d.exe})`;
            if (d.name) return d.name;
            if (d.path) return d.path;
            if (d.ip) return `${d.ip}${d.mac ? ' (' + d.mac + ')' : ''}`;
            if (d.rule) return d.rule;
            return JSON.stringify(d).substring(0, 120);
        },
    };
}
</script>
{% endblock %}
