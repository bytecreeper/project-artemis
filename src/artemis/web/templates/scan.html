{% extends "base.html" %}
{% block title %}Vulnerability Scanner — Artemis{% endblock %}

{% block content %}
<div x-data="scanApp()" x-init="loadScanners()" style="padding: 24px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <div>
            <h2 style="font-family: var(--font-mono); color: var(--amber); font-size: 18px; margin: 0;">[V] VULNERABILITY SCANNER</h2>
            <p style="color: var(--text-muted); font-size: 13px; margin: 4px 0 0;">Scan hosts for security weaknesses, misconfigurations, and exposed services.</p>
        </div>
    </div>

    <!-- Scan Controls -->
    <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 24px;">
        <div style="display: flex; gap: 16px; align-items: flex-end; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
                <label style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;">Target</label>
                <select x-model="target" style="width: 100%; background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-primary); padding: 10px; border-radius: 4px; font-family: var(--font-mono); margin-top: 4px;">
                    <option value="localhost">This Machine (localhost)</option>
                    <option value="network">All Network Hosts</option>
                </select>
            </div>
            <button @click="runScan()" :disabled="scanning"
                style="background: var(--amber); color: var(--bg-primary); border: none; padding: 10px 24px; border-radius: 6px; font-family: var(--font-mono); font-weight: 700; font-size: 13px; cursor: pointer; height: 42px;"
                :style="scanning ? 'opacity: 0.5; cursor: not-allowed;' : ''">
                <span x-show="!scanning">RUN SCAN</span>
                <span x-show="scanning">SCANNING...</span>
            </button>
        </div>

        <!-- Available Scanners -->
        <div style="margin-top: 16px;">
            <label style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;">Active Scanners</label>
            <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;">
                <template x-for="s in scanners" :key="s.name">
                    <span style="background: var(--bg-primary); border: 1px solid var(--border); padding: 4px 12px; border-radius: 4px; font-size: 12px; font-family: var(--font-mono);">
                        <span style="color: var(--amber);" x-text="s.name"></span>
                        <span style="color: var(--text-muted); font-size: 10px;" x-text="' — ' + s.description"></span>
                    </span>
                </template>
            </div>
        </div>
    </div>

    <!-- Status -->
    <div x-show="statusMsg" x-transition style="padding: 12px 16px; border-radius: 6px; margin-bottom: 16px; font-size: 13px; font-family: var(--font-mono); background: rgba(255,191,0,0.1); border: 1px solid rgba(255,191,0,0.3); color: var(--amber);" x-text="statusMsg"></div>

    <!-- Results Summary -->
    <template x-if="results">
        <div style="margin-bottom: 24px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 16px;">
                <div class="scan-stat" style="border-left: 3px solid #ff3333;">
                    <div style="font-size: 24px; font-weight: 800; font-family: var(--font-mono);" x-text="results.summary?.by_severity?.critical || 0"></div>
                    <div style="font-size: 11px; color: #ff3333;">CRITICAL</div>
                </div>
                <div class="scan-stat" style="border-left: 3px solid #ff6633;">
                    <div style="font-size: 24px; font-weight: 800; font-family: var(--font-mono);" x-text="results.summary?.by_severity?.high || 0"></div>
                    <div style="font-size: 11px; color: #ff6633;">HIGH</div>
                </div>
                <div class="scan-stat" style="border-left: 3px solid #ffbf00;">
                    <div style="font-size: 24px; font-weight: 800; font-family: var(--font-mono);" x-text="results.summary?.by_severity?.medium || 0"></div>
                    <div style="font-size: 11px; color: #ffbf00;">MEDIUM</div>
                </div>
                <div class="scan-stat" style="border-left: 3px solid #66ccff;">
                    <div style="font-size: 24px; font-weight: 800; font-family: var(--font-mono);" x-text="results.summary?.by_severity?.low || 0"></div>
                    <div style="font-size: 11px; color: #66ccff;">LOW</div>
                </div>
                <div class="scan-stat" style="border-left: 3px solid #888;">
                    <div style="font-size: 24px; font-weight: 800; font-family: var(--font-mono);" x-text="results.summary?.by_severity?.info || 0"></div>
                    <div style="font-size: 11px; color: #888;">INFO</div>
                </div>
            </div>
        </div>
    </template>

    <!-- Findings -->
    <template x-if="results && results.findings.length > 0">
        <div>
            <h3 style="font-family: var(--font-mono); color: var(--amber); font-size: 14px; margin: 0 0 12px;">[!] FINDINGS (<span x-text="results.findings.length"></span>)</h3>
            <template x-for="f in results.findings" :key="f.id">
                <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 8px;">
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <span :style="`background:${sevColor(f.severity)};color:#000;padding:2px 8px;border-radius:3px;font-size:10px;font-weight:700;text-transform:uppercase;flex-shrink:0;`" x-text="f.severity"></span>
                        <div style="flex: 1;">
                            <div style="font-weight: 700;" x-text="f.title"></div>
                            <div style="font-size: 13px; color: var(--text-muted); margin-top: 4px;" x-text="f.description"></div>
                            <div x-show="f.technical_detail" style="font-size: 12px; color: var(--text-muted); margin-top: 4px; font-family: var(--font-mono); background: var(--bg-primary); padding: 6px 10px; border-radius: 4px; margin-top: 8px;" x-text="f.technical_detail"></div>
                            <div x-show="f.remediation" style="font-size: 12px; color: #00ff41; margin-top: 8px;">
                                <strong>Fix:</strong> <span x-text="f.remediation"></span>
                            </div>
                            <div style="display: flex; gap: 12px; margin-top: 8px; font-size: 11px; color: var(--text-muted);">
                                <span x-show="f.mitre_id" style="color: var(--amber);" x-text="f.mitre_id"></span>
                                <span x-show="f.cve" style="color: #ff6633;" x-text="f.cve"></span>
                                <span x-text="f.category"></span>
                                <span>Scanner: <span x-text="f.scanner"></span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </template>

    <template x-if="results && results.findings.length === 0">
        <div style="text-align: center; padding: 40px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px;">
            <div style="font-size: 48px; margin-bottom: 12px; color: #00ff41;">&#10003;</div>
            <h3 style="color: #00ff41; margin: 0 0 8px;">No Vulnerabilities Found</h3>
            <p style="color: var(--text-muted); font-size: 14px;">Scan completed with no findings.</p>
        </div>
    </template>
</div>

<style>
    .scan-stat {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 16px;
        text-align: center;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
function scanApp() {
    return {
        target: 'localhost',
        scanners: [],
        scanning: false,
        results: null,
        statusMsg: '',

        async loadScanners() {
            try {
                const r = await fetch('/api/scan/scanners');
                this.scanners = await r.json();
            } catch(e) {}
        },

        async runScan() {
            this.scanning = true;
            this.results = null;
            this.statusMsg = `Scanning ${this.target}...`;
            try {
                const r = await fetch('/api/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target: this.target }),
                });
                this.results = await r.json();
                this.statusMsg = `Scan complete — ${this.results.findings_count} findings`;
            } catch(e) {
                this.statusMsg = 'Scan failed: ' + e.message;
            }
            this.scanning = false;
        },

        sevColor(sev) {
            return { critical: '#ff3333', high: '#ff6633', medium: '#ffbf00', low: '#66ccff', info: '#888' }[sev] || '#888';
        }
    };
}
</script>
{% endblock %}
