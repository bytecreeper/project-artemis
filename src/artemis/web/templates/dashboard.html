{% extends "base.html" %}
{% set active = "dashboard" %}
{% block title %}Artemis Archer — Operations Dashboard{% endblock %}

{% block content %}
<div x-data="dashboard()" x-init="init()">

    <!-- Top Stats Row -->
    <div class="grid-4 stagger mb-24">
        <div class="stat-card">
            <div class="stat-value" x-text="stats.events_24h || 0"></div>
            <div class="stat-label">Events (24h)</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" :style="(stats.open_alerts || 0) > 0 ? 'color: var(--red)' : ''" x-text="stats.open_alerts || 0"></div>
            <div class="stat-label">Open Alerts</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="color: var(--blue);" x-text="stats.network_hosts || 0"></div>
            <div class="stat-label">Network Hosts</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="color: var(--green);" x-text="stats.edr_plugins || 0"></div>
            <div class="stat-label">EDR Modules</div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid-2 mb-24">
        <!-- Event Timeline Chart -->
        <div class="card">
            <h3>≡ Event Timeline (24h)</h3>
            <div class="chart-container" style="height: 180px;">
                <canvas id="timelineChart"></canvas>
            </div>
        </div>

        <!-- Severity Distribution -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="margin-bottom: 0;">△ Severity Distribution</h3>
            </div>
            <div style="display: flex; align-items: center; gap: 24px;">
                <div style="width: 140px; height: 140px; flex-shrink: 0;">
                    <canvas id="severityChart"></canvas>
                </div>
                <div style="flex: 1; display: flex; flex-direction: column; gap: 8px;">
                    <template x-for="s in severityBreakdown" :key="s.label">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 10px; height: 10px; border-radius: 2px; flex-shrink: 0;" :style="`background: ${s.color}`"></div>
                            <span style="font-size: 12px; color: var(--text-secondary); flex: 1;" x-text="s.label"></span>
                            <span class="mono" style="font-size: 12px; font-weight: 600;" :style="`color: ${s.color}`" x-text="s.count"></span>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Middle Row: Live Feed + Alerts -->
    <div class="grid-2 mb-24">
        <!-- Live Event Feed -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="margin-bottom: 0;"><span class="dot ok live" style="margin-right: 6px;"></span>Live Event Feed</h3>
                <span class="mono" style="font-size: 10px; color: var(--text-muted);" x-text="events.length + ' events'"></span>
            </div>
            <div class="event-feed">
                <template x-if="events.length === 0">
                    <div style="color: var(--text-muted); padding: 20px; text-align: center; font-size: 12px;">Awaiting events...</div>
                </template>
                <template x-for="(ev, i) in events.slice(0, 25)" :key="ev.id || i">
                    <div class="event-feed-item" :style="`animation-delay: ${i * 0.03}s`">
                        <div class="severity-dot" :style="`background: ${sevColor(ev.severity)}`"></div>
                        <span class="ev-time" x-text="formatTime(ev.timestamp)"></span>
                        <span class="ev-type" x-text="ev.type ? ev.type.split('.').pop() : ''"></span>
                        <span class="ev-detail" x-text="eventSummary(ev)"></span>
                    </div>
                </template>
            </div>
        </div>

        <!-- Alerts -->
        <div class="card">
            <h3>△ Recent Alerts</h3>
            <template x-if="alerts.length === 0">
                <div style="color: var(--text-muted); padding: 20px; text-align: center; font-size: 12px;">
                    <span style="font-size: 24px; display: block; margin-bottom: 8px; opacity: 0.5;">✓</span>
                    No open alerts — systems nominal
                </div>
            </template>
            <div style="display: flex; flex-direction: column; gap: 4px;">
                <template x-for="alert in alerts.slice(0, 8)" :key="alert.id">
                    <div style="display: flex; align-items: flex-start; gap: 10px; padding: 10px 12px; background: var(--bg-elevated); border-radius: var(--radius-xs); transition: all 0.15s;" class="animate-in">
                        <div class="severity-dot" style="margin-top: 5px;" :style="`background: ${sevColorNum(alert.severity)}`"></div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 12px; font-weight: 600;" x-text="alert.title || alert.headline || 'Alert'"></div>
                            <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" x-text="alert.description || alert.plain || ''"></div>
                        </div>
                        <span class="badge" :class="severityClass(alert.severity)" x-text="severityLabel(alert.severity)"></span>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- Bottom Row: EDR Status + Network Hosts -->
    <div class="grid-2">
        <!-- EDR Status -->
        <div class="card">
            <h3>▣ EDR Modules</h3>
            <template x-if="Object.keys(edrStatus).length === 0">
                <div style="color: var(--text-muted); padding: 12px 0; font-size: 12px;">No modules loaded.</div>
            </template>
            <div style="display: flex; flex-direction: column; gap: 4px;">
                <template x-for="(status, name) in edrStatus" :key="name">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: var(--bg-elevated); border-radius: var(--radius-xs);">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="dot" :class="status.running ? 'ok' : 'err'"></span>
                            <span class="mono" style="font-size: 12px; font-weight: 600;" x-text="name"></span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <template x-if="status.events_processed !== undefined">
                                <span style="color: var(--text-muted); font-size: 10px; font-family: var(--font-mono);" x-text="status.events_processed + ' events'"></span>
                            </template>
                            <template x-if="status.events_emitted !== undefined">
                                <span style="color: var(--text-muted); font-size: 10px; font-family: var(--font-mono);" x-text="status.events_emitted + ' emitted'"></span>
                            </template>
                            <template x-if="status.tracked_files !== undefined">
                                <span style="color: var(--text-muted); font-size: 10px; font-family: var(--font-mono);" x-text="status.tracked_files + ' files'"></span>
                            </template>
                            <span class="badge" :class="status.running ? 'low' : 'critical'" x-text="status.running ? 'ACTIVE' : 'DOWN'"></span>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Network Host Grid -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="margin-bottom: 0;">⬡ Network Hosts</h3>
                <span class="mono" style="font-size: 10px; color: var(--text-muted);" x-text="hosts.length + ' discovered'"></span>
            </div>
            <template x-if="hosts.length === 0">
                <div style="color: var(--text-muted); padding: 12px 0; font-size: 12px;">Scanning network...</div>
            </template>
            <div class="host-grid">
                <template x-for="host in hosts" :key="host.ip">
                    <div class="host-tile">
                        <div style="margin-bottom: 4px;">
                            <span class="dot ok" style="width: 5px; height: 5px;"></span>
                        </div>
                        <div class="host-ip" x-text="host.ip"></div>
                        <div style="font-size: 9px; color: var(--text-muted); margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" x-text="host.hostname || host.mac || '—'"></div>
                    </div>
                </template>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function dashboard() {
    return {
        stats: { events_24h: 0, open_alerts: 0, network_hosts: 0, edr_plugins: 0 },
        alerts: [],
        edrStatus: {},
        events: [],
        hosts: [],
        severityBreakdown: [],
        timelineChart: null,
        severityChart: null,

        async init() {
            await this.refresh();
            this.buildCharts();
            setInterval(() => this.refresh(), 5000);
        },

        async refresh() {
            try {
                const [statsR, alertsR, hostsR, edrR, eventsR] = await Promise.allSettled([
                    fetch('/api/stats').then(r => r.json()),
                    fetch('/api/alerts').then(r => r.json()),
                    fetch('/api/network/hosts').then(r => r.json()),
                    fetch('/api/edr/status').then(r => r.json()),
                    fetch('/api/events?limit=25').then(r => r.json()),
                ]);

                if (statsR.status === 'fulfilled') this.stats = statsR.value;
                if (alertsR.status === 'fulfilled') this.alerts = alertsR.value;
                if (hostsR.status === 'fulfilled') {
                    this.hosts = hostsR.value;
                    this.stats.network_hosts = this.hosts.length;
                }
                if (edrR.status === 'fulfilled') this.edrStatus = edrR.value;
                if (eventsR.status === 'fulfilled') {
                    this.events = eventsR.value;
                    this.updateCharts();
                }
            } catch (e) {
                console.error('Refresh failed:', e);
            }
        },

        buildCharts() {
            // Timeline chart
            const tlCtx = document.getElementById('timelineChart');
            if (tlCtx) {
                this.timelineChart = new Chart(tlCtx, {
                    type: 'line',
                    data: {
                        labels: this.getTimeLabels(),
                        datasets: [{
                            data: this.getTimeData(),
                            borderColor: '#f5a623',
                            backgroundColor: 'rgba(245, 166, 35, 0.08)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 4,
                            pointHoverBackgroundColor: '#f5a623',
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { intersect: false, mode: 'index' },
                        scales: {
                            x: { grid: { display: false }, ticks: { maxTicksLimit: 8 } },
                            y: { grid: { color: '#1e1e2a' }, beginAtZero: true, ticks: { maxTicksLimit: 5 } },
                        },
                        plugins: { tooltip: { backgroundColor: '#12121a', borderColor: '#2a2a38', borderWidth: 1 } },
                    }
                });
            }

            // Severity donut
            const sevCtx = document.getElementById('severityChart');
            if (sevCtx) {
                this.severityChart = new Chart(sevCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Low', 'Medium', 'High', 'Critical'],
                        datasets: [{
                            data: [1, 0, 0, 0],
                            backgroundColor: ['#22c55e', '#eab308', '#f5a623', '#ef4444'],
                            borderWidth: 0,
                            hoverOffset: 4,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        cutout: '65%',
                        plugins: { tooltip: { backgroundColor: '#12121a', borderColor: '#2a2a38', borderWidth: 1 } },
                    }
                });
            }
        },

        updateCharts() {
            // Severity counts from events
            const counts = [0, 0, 0, 0]; // low, med, high, crit
            this.events.forEach(ev => {
                const s = ev.severity || 1;
                if (s <= 1) counts[0]++;
                else if (s === 2) counts[0]++;
                else if (s === 3) counts[1]++;
                else if (s === 4) counts[2]++;
                else counts[3]++;
            });

            this.severityBreakdown = [
                { label: 'Low', count: counts[0], color: '#22c55e' },
                { label: 'Medium', count: counts[1], color: '#eab308' },
                { label: 'High', count: counts[2], color: '#f5a623' },
                { label: 'Critical', count: counts[3], color: '#ef4444' },
            ];

            if (this.severityChart) {
                this.severityChart.data.datasets[0].data = counts.map(c => c || 0);
                // Ensure at least one value for donut to render
                if (counts.every(c => c === 0)) this.severityChart.data.datasets[0].data = [1, 0, 0, 0];
                this.severityChart.update('none');
            }

            if (this.timelineChart) {
                this.timelineChart.data.labels = this.getTimeLabels();
                this.timelineChart.data.datasets[0].data = this.getTimeData();
                this.timelineChart.update('none');
            }
        },

        getTimeLabels() {
            const labels = [];
            for (let i = 23; i >= 0; i--) {
                const d = new Date(Date.now() - i * 3600000);
                labels.push(d.getHours().toString().padStart(2, '0') + ':00');
            }
            return labels;
        },

        getTimeData() {
            const buckets = new Array(24).fill(0);
            const now = Date.now();
            this.events.forEach(ev => {
                const ts = new Date(ev.timestamp).getTime();
                const hoursAgo = Math.floor((now - ts) / 3600000);
                if (hoursAgo >= 0 && hoursAgo < 24) {
                    buckets[23 - hoursAgo]++;
                }
            });
            return buckets;
        },

        formatTime(ts) {
            if (!ts) return '-';
            try {
                const d = new Date(ts);
                return d.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            } catch { return ts; }
        },

        formatPorts(ports) {
            if (!ports) return 'none';
            if (typeof ports === 'string') {
                try { ports = JSON.parse(ports); } catch { return ports; }
            }
            if (Array.isArray(ports) && ports.length > 0) return ports.join(', ');
            return 'none';
        },

        eventSummary(event) {
            const d = event.data;
            if (!d || typeof d !== 'object') return '';
            if (d.name) return d.name + (d.cmdline ? ': ' + d.cmdline.substring(0, 60) : '');
            if (d.pid) return 'PID ' + d.pid;
            if (d.path) return d.path;
            if (d.ip) return d.ip;
            if (d.sysmon_event_id) return 'Sysmon ID ' + d.sysmon_event_id;
            return JSON.stringify(d).substring(0, 80);
        },

        sevColor(s) {
            return ['#22c55e','#22c55e','#eab308','#f5a623','#ef4444'][s] || '#22c55e';
        },
        sevColorNum(s) {
            return ['#22c55e','#22c55e','#eab308','#f5a623','#ef4444'][s] || '#22c55e';
        },
        severityClass(s) {
            return ['low','low','medium','high','critical'][s] || 'low';
        },
        severityLabel(s) {
            return ['INFO','LOW','MED','HIGH','CRIT'][s] || 'INFO';
        },
    };
}
</script>
{% endblock %}
